# [데이터온](https://data-on.co.kr) 웹 인프라 구축

## 1. host설정

```bash
vi /etc/hosts # 127.0.0.1 openmateon-116698 입력
```

## 2. docker-compose 설치

```bash
apt update && apt install -y docker-compose
```

## 3. MTU 변경(Host OS)

```bash
# iwinv는 기본 MTU 1450 But, docker 컨테이너 기본 MTU 1500
# 다르면 docker 네트워크 통신 안됨

cp /lib/systemd/system/docker.service /etc/systemd/system/docker.service
vi /etc/systemd/system/docker.service # ExecStart=/usr/bin/dockerd -H fd:// --mtu 1450 # 추가
systemctl daemon-reload
service docker restart
```

## 4. docker 컨트롤 유저 생성

```bash
adduser data-on
usermod -aG sudo data-on
```

## 5. 프로젝트 다운로드

```bash
su - data-on
git config --global http.sslVerify false
git clone git@git.openmate-on.co.kr:Data-Service/Data-ON.git
```

## 6. ssl 저장 볼륨 직접 생성

```bash
sudo docker volume create --name=letsencrypt_etc
sudo docker volume create --name=letsencrypt_lib
```

## 7. ssl 생성

```bash
# 도메인 발급기관에서 해당도메인에 대한 txt타입 추가
sudo docker run -it --rm --name certbot \
  -v 'letsencrypt_etc:/etc/letsencrypt' \
  -v 'letsencrypt_lib:/var/lib/letsencrypt' \
  certbot/certbot certonly -d 'data-on.co.kr' --manual --preferred-challenges dns --server https://acme-v02.api.letsencrypt.org/directory
```

## 8. crontab에 ssl 갱신 명령어 추가

```bash
sudo crontab -e # 하단 명령어 기입

# 6, 5,10, * * * docker run -it --rm --name certbot -v 'letsencrypt_etc:/etc/letsencrypt' -v 'letsencrypt_lib:/var/lib/letsencrypt' certbot/certbot renew --manual --preferred-challenges dns --server https://acme-v02.api.letsencrypt.org/directory
```

[참조](https://openmatetest.sharepoint.com/:p:/s/OPENmate_ONIntranet2/EUYgKyHAmvlCvtRRn3OmNkoBMC6Q4EiNZRRffKJQa1esMA?e=a0USGz)

## 9. 서비스 컨테이너 생성

```bash
cd Data-ON && sudo docker-compose up -d
```

<br/><br/>

# 예외처리

## 1. nginx 컨테이너만 적용

```bash
sudo docker stop data_on_nginx
sudo docker rm data_on_nginx
sudo docker start data_on_nginx
```

## 2. FE 컨테이너만 적용

```bash
sudo docker stop data_on_frontend
sudo docker rm data_on_frontend
sudo docker start data_on_frontend
```

## 3. BE 컨테이너만 적용

```bash
sudo docker stop data_on_backend
sudo docker rm data_on_backend
sudo docker start data_on_backend
```

## 4. 모든 서비스 컨테이너 삭제

```bash
# 관련 볼륨, 이미지, 네트워크 제거
cd /home/data-on/Data-ON
sudo docker-compose down
sudo docker system prune -a
sudo docker volume prune
```
